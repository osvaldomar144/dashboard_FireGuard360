{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <h1 class="h3 mb-4 text-gray-800">Controlli</h1>

  <!-- Messaggio di Rischio -->
  <div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
      <h6 class="m-0 font-weight-bold text-primary">Rischio Attuale</h6>
    </div>
    <div class="card-body">
      <div id="rischioStatus" class="alert alert-primary">
        Nessun rischio attuale.
      </div>

      <!-- Nuovo messaggio con la data dell'evento -->
      <div id="dataEvento" class="mt-3 text-muted">
        <!-- Messaggio di data dell'evento verrà aggiunto dinamicamente -->
      </div>
    </div>
  </div>

  <!-- Card Controllo Relè -->
  <div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
      <h6 class="m-0 font-weight-bold text-primary">Gestione Relè</h6>
    </div>
    <div class="card-body">

      <p>Usa l'interruttore per accendere o spegnere il relè.</p>

      <!-- Toggle Switch -->
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="releToggle" role="switch" onchange="toggleSwitch(this)">
        <label class="form-check-label ms-2" for="releToggle">Relè</label>
      </div>

      <!-- Stato Attuale -->
      <div id="releStatus" class="mt-3">
        <span class="badge badge-secondary p-2">Stato attuale: sconosciuto</span>
      </div>

    </div>
  </div>

  <!-- Card per Visualizzare il Modello 3D -->
  <div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
      <h6 class="m-0 font-weight-bold text-primary">Visualizzazione Modello 3D</h6>
    </div>
    <div class="card-body">
      <!-- Iframe per visualizzare il modello 3D -->
      <iframe
        width="100%" height="500" style="border:1px solid #eeeeee;"
        src="https://3dviewer.net/embed.html#model=https://raw.githubusercontent.com/MartinaLucianii/modelRender/refs/heads/main/3d-model 2.obj">
      </iframe>
    </div>
  </div>
</div>

<!-- Script JS -->
<script>

  function toggleSwitch(el) {
    const stato = el.checked ? 'on' : 'off';
    fetch(`/controllo/rele/${stato}`, { method: 'POST' })
      .then(res => res.json())
      .then(data => aggiornaBadge(data.stato));
  }

  function aggiornaBadge(stato) {
    const badge = document.querySelector("#releStatus span");
    badge.className = "badge p-2";
    badge.textContent = "Stato attuale: " + stato.toUpperCase();

    if (stato === "on") {
      badge.classList.add("badge-success");
    } else if (stato === "off") {
      badge.classList.add("badge-danger");
    } else {
      badge.classList.add("badge-secondary");
    }
  }

  // Stato iniziale al caricamento
  window.onload = () => {
    fetch('/controllo/rele/stato', { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        document.getElementById("releToggle").checked = data.stato === "on";
        aggiornaBadge(data.stato);
      });

    // Recupera l'ultimo evento di rischio per mostrare il messaggio
    fetch('/get_last_risk_event')
      .then(res => res.json())
      .then(data => {
        const rischioElement = document.getElementById('rischioStatus');
        const dataEventoElement = document.getElementById('dataEvento');
        
        if (data.rischio) {
          rischioElement.textContent = `⚠️ ${data.rischio}`;
          rischioElement.classList.remove('alert-primary');
          rischioElement.classList.add(data.rischio === 'Attenzione' ? 'alert-primary' : 'alert-danger');

          // Mostra la data dell'evento
          const eventDate = new Date(data.data_ora);
          dataEventoElement.textContent = `Evento rilevato il: ${eventDate.toLocaleString()}`;
        } else {
          rischioElement.textContent = 'Nessun rischio attuale.';
          rischioElement.classList.remove('alert-primary', 'alert-danger');
          rischioElement.classList.add('alert-secondary');

          // Non c'è rischio, quindi non mostrare la data evento
          dataEventoElement.textContent = '';
        }
      });
  }
</script>

{% endblock %}